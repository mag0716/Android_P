# Android App Bundle を使う場合にリリース担当者に行ってもらう必要がある作業まとめ

* 以下の前提での作業
  * アプリの生成は開発者が行う
  * アップロード用の署名ファイルは、開発者が管理しない可能性もある

## (署名用の鍵を管理している場合)署名ファイルを Play Console に登録する

* https://support.google.com/googleplay/android-developer/answer/7384423

### 新規アプリ

新規アプリの場合は、リリース時に Google Play App Signing を有効にします

1. 署名ファイル、アップロード用の署名ファイルを生成する
  * https://developer.android.com/studio/publish/app-signing
1. Play Console を開く
1. 「アプリの作成」を選択し、必要な情報を入力し、作成する
1. 「アプリのリリース」を選択し、`*.aab`　をアップロードする
  * テスト用の内部テスト版トラックで問題ない
1. 「Google Play アプリ署名」で「次へ」を選択する
1. 「追加する Android App Bundle と APK」で、**アップロード用の署名ファイルで** 生成した、`*.aab`　を選択する
1. 「リリース名」、「このリリースの新機能」などに適切な内容を設定し、「保存」を選択
1. 「アプリの署名」を選択すると、「アプリへの署名証明書」「アップロード証明書」が登録されていることが確認できます

### 既存アプリ

既存アプリの場合は、`*.aab` のリリース前に、Google Play App Signing を有効にする必要があります

1. アップロード用の署名ファイルを生成する
  * https://developer.android.com/studio/publish/app-signing
1. Play Console を開く
1. アプリを選択し、「リリース管理」->「アプリの署名」を選択する
  * 利用規約が表示されたら同意する
1. 「アプリ署名鍵がエクスポートされていません」を選択する
  * 「PEPK ツール」をタップし、ツールをダウンロードする
  * ツールを利用し、今まで利用していた署名ファイルから、秘密鍵のエクスポートと暗号化を行う
  * 「アプリ署名の秘密鍵」から秘密鍵を選択する
  * 「アップロード公開鍵の証明書」からアップロード鍵の証明書をアップロードする
1. 「省略可: アプリ署名鍵のセキュリティを強化する」を選択する
  * 記載の方法で、アップロード用の署名ファイルから PEM ファイルをエクスポートする
  * 「アップロード公開鍵の証明書」から、エクポートした PEM ファイルを選択する
1. 「登録」ボタンをタップする
1. 成功すると、以下のような画面が表示されます
  * これで Google Play App Signing が有効になりました

## アップロード用の鍵で `*.aab` を署名する

開発者から未署名の `*.aab` が提供された場合、以下の作業が必要です

## Play Console にアップロードする

* `*.apk` と同様のアップロード手順で OK

### テストする場合

dynamic feature modules が含まれている場合は、テストのために、内部テスト版などとしてリリースする必要があります。
dynamic feature modules が含まれていない場合は、必須ではありませんが、内部テスト版としてリリースしておくと便利です。

注意点としては、内部テスト版としてリリースする際も、versionCode のアップデートが必要になります。

以下の手順で内部テスト版としてのリリースできます

1. Play Console を開く
1. 「テスターの管理」を選択する
1. 「テスト方法の選択」で「内部テスト」を選択し、「リストを作成」を選択する
1. 「リスト名」、「テスターのメールアドレス」を入力し、「保存」を選択する
1. アプリを選択し、「リリース管理」->「アプリのリリース」を選択する
1. 内部テスト版の「管理」を選択する
1. 「リリースを作成」を選択し、テスト対象のファイルをアップロードする
1. 「リリース名」、「このリリースの新機能」を入力し、「確認」を選択する
1. 公開が完了したら、「テスターの管理」の「オプトインURL」をテスターに共有します
1. テスターは共有された、「オプトインURL」からテスターになる
1. これで、テスターはアプリをインストールできるようになる

テストアプリをアップデートすると、すでにインストールされていれば、テスターは Google Play アプリからアップデートが可能です

## つまったこと

* 「アプリ署名の秘密鍵」で Android Studio 3.2 Canary 16 で生成した秘密鍵を選択すると、「秘密鍵が正しく暗号化されていないか、サポートされない種類です。別の秘密鍵を送信してください。」おとなり登録できない
  * 選択したアプリに署名されている keystore と異なる keystore を利用したから
* 内部テストで公開ができなかった
  * リリース用の情報などダミーでもいいので、設定しておく必要がある
